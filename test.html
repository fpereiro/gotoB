<!DOCTYPE HTML>
<html>
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="initial-scale=1">
      <title>gotoв!</title>
   </head>
   <body>
      <noscript>Javascript is deactivated in your browser. Please activate it in order to use this page.</noscript>
      <script>
         var Time = {zero: new Date ().getTime ()};
      </script>
      <script src="gotoB.min.js"></script>
      <script>
         Time ['0: load-gotoB'] = Date.now () - Time.zero;
      </script>
      <script>
         (function () {

            // *** SETUP ***

            var dale = window.dale, teishi = window.teishi, lith = window.lith, c = window.c, B = window.B;

            var type = teishi.t, log = teishi.l;

            var Data  = window.Data  = B.store.Data  = {};
            var State = window.State = B.store.State = {};

            var Test = function (tag, fun) {
               if (B.prod) return;
               var error = fun ();
               if (error) throw new Error (tag + ': ' + error);
               log ('Test OK', tag);
            }

            // *** PROD MODE ***

            B.prod = false;

            // *** INITIAL ROUTES ***

            Test ('initial setup', function () {
               if (teishi.s (dale.keys (B.routes).sort ()) !== teishi.s (['add', 'debug', 'rem', 'set'])) return 'Initial routes mismatch.';
               if (B.debug.length !== 0) return 'Extraneous elements in debug history.';
            });

            // *** B.DEBUG ***

            B.listen ('test', 'debug', {burn: true}, function () {

               B.do ('verb1', 'a path', 'booyah');
               B.do ('verb2', 'a path');

               Test ('B.debug', function () {
                  if (B.debug.length !== 3) return 'B.debug is not registering events.';
                  if (B.debug [0].verb !== 'verb2') return 'B.debug is not registering verbs.';
                  if (B.debug [0].path [0] !== 'a path') return 'B.debug is not registering paths.';
                  if (B.debug [1].args [0] !== 'booyah') return 'B.debug is not registering args.';
                  if (B.debug [0].args !== undefined) return 'B.debug is registering non-existing args.';
               });

               B.do ('test', 'args');
            });

            setTimeout (function () {
               B.do ('test', 'debug');
            }, 0);

            // *** ARGS ***

            B.listen ('test', 'args', {burn: true}, function () {

               Data.items = [];

               Test ('args validations', function () {
                  if (B.add ()                        !== false) return 'B.add accepted empty path.';
                  if (B.add ([])                      !== false) return 'B.add accepted empty path.';
                  if (B.add (/invalidpath/)           !== false) return 'B.add accepted invalid path.';
                  if (B.add ({})                      !== false) return 'B.add accepted invalid path.';
                  if (B.add (['Data', /invalidpath/]) !== false) return 'B.add accepted invalid path.';
                  if (B.add (['lalala'], 'whatever')  !== false) return 'B.add accepted target that is not an array.';

                  if (B.rem ()                             !== false) return 'B.rem accepted undefined path.';
                  if (B.rem (/invalidpath/)                !== false) return 'B.rem accepted invalid path.';
                  if (B.rem ({})                           !== false) return 'B.rem accepted invalid path.';
                  if (B.rem (['lalala'], 'whatever')       !== false) return 'B.rem accepted target that is not an array.';
                  if (B.rem (['Data', 'items'], undefined) !== false) return 'B.rem accepted keys that are neither integers or strings';
                  if (B.rem (['Data', 'items'], {a: 0})    !== false) return 'B.rem accepted keys that are neither integers or strings';
                  if (B.rem (['Data', 'items'], [0, 'b'])  !== false) return 'B.rem accepted keys that are neither integers or strings';
                  if (B.rem (['No item'], 0)  !== false) return 'B.rem didn\'t reject target that is simple.';

                  if (B.get ('ok', /notok/)               !== undefined) return 'B.get accepted invalid path';
                  if (B.get ({})                          !== undefined) return 'B.get accepted invalid path';
                  if (B.get (['ok', /notok/])             !== undefined) return 'B.get accepted invalid path';
                  if (B.get (['ok', /notok/], /dontcare/) !== undefined) return 'B.get accepted invalid path';

                  if (B.set (/invalidpath/)                   !== false) return 'B.set accepted invalid path.';
                  if (B.set ({})                              !== false) return 'B.set accepted invalid path.';
                  if (B.set (['lalala', /nope/])              !== false) return 'B.set accepted invalid path.';
                  if (B.set (/invalidpath/, 'something')      !== false) return 'B.set accepted invalid path.';
                  if (B.set (['lalala', /nope/], 'something') !== false) return 'B.set accepted invalid path.';
               });

               Test ('args circuit', function () {

                  if (B.get ('Data')            !== Data)       return 'B.get single path comparison #1 didn\'t work.';
                  if (B.get (['Data'])          !== Data)       return 'B.get single path comparison #2 didn\'t work.';
                  if (B.get (['Data', 'items']) !== Data.items) return 'B.get double path comparison #1 didn\'t work.';
                  if (B.get ('Data', 'items')   !== Data.items) return 'B.get double path comparison #2 didn\'t work.';

                  if (B.add (['Data', 'items'], 'one') !== true) return 'B.add didn\'t return true.';
                  if (B.get ('Data', 'items', 0) !== 'one') return 'B.add didn\'t add element.';
                  if (B.add (['Data', 'items'], ['two', 'three']) !== true) return 'B.add didn\'t return true.';
                  if (Data.items.length !== 2) return 'B.add didn\'t add array properly.';
                  if (B.get ('Data', 'items', 1, 0) !== 'two') return 'B.add didn\'t add array properly.';
                  if (B.get ('Data', 'items', 1, 1) !== 'three') return 'B.add didn\'t add array properly.';
                  if (B.add (['Data', 'items'], undefined, 'four', {five: 5}) !== true) return 'B.add didn\'t return true.';
                  if (Data.items.length !== 5) return 'B.add didn\'t add multiple arguments properly.';
                  if (B.get ('Data', 'items', 2) !== undefined) return 'B.add didn\'t add undefined properly.';
                  if (B.get ('Data', 'items', 3) !== 'four') return 'B.add didn\'t add multiple arguments properly.';
                  if (B.get ('Data', 'items', 4, 'five') !== 5) return 'B.add didn\'t add multiple arguments properly.';
                  if (B.add (['Data', 'items', 4], 'six') !== false) return 'B.add attempted to add element to object.';

                  if (B.set (['Data', 'items', 4, 'six'], 6) !== true) return 'B.set didn\'t return true.';
                  if (B.get ('Data', 'items', 4, 'six') !== 6) return 'B.set didn\'t set object property in existing object.';
                  if (B.set (['Data', 'items', 5], 'seven') !== true) return 'B.set didn\'t return true.';
                  if (B.get ('Data', 'items', 5) !== 'seven') return 'B.set didn\'t set array element in existing array.';
                  if (B.set (['Data', 'items', 6], false) !== true) return 'B.set didn\'t set false value.';
                  if (B.get ('Data', 'items', 6) !== false) return 'B.get didn\'t return false value properly.';
                  Data.items.splice (6, 1);

                  if (B.set ('Other', true) !== true) return 'B.set didn\'t return true.';
                  if (B.get ('Other') !== true) return 'B.set didn\'t set toplevel property.';

                  if (B.set (['Data', 'arr', 0], true) !== true) return 'B.set didn\'t return true.';
                  if (type (Data.arr) !== 'array') return 'B.set didn\'t create nested structures (array).';
                  if (B.get ('Data', 'arr', 0) !== true) return 'B.set didn\'t create nested structures (array).';
                  if (B.set (['Data', 'obj', 'last'], 'playboy') !== true) return 'B.set didn\'t return true.';
                  if (type (Data.obj) !== 'object') return 'B.set didn\'t create nested structures (object).';
                  if (B.get ('Data', 'obj', 'last') !== 'playboy') return 'B.set didn\'t create nested structures (object).';
                  if (B.set (['Data', 2], 'two') !== false) return 'B.set didn\'t return false when overwriting parent.';

                  if (type (Data) !== 'object') return 'B.set overwrote target on type coercion.';
                  if (B.get ('Data', 2) !== undefined) return 'B.set didn\'t write key when target required type coercion.';
                  if (B.set (['Data', 'arr2', 1, 0, 'obj'], 'verynested') !== true) return 'B.set didn\'t return true.';
                  if (type (B.get ('Data', 'arr2')) !== 'array') return 'B.set didn\'t create multiple nested sequence properly.';
                  if (type (B.get ('Data', 'arr2', 1)) !== 'array') return 'B.set didn\'t create multiple nested sequence properly.';
                  if (type (B.get ('Data', 'arr2', 1, 0)) !== 'object') return 'B.set didn\'t create multiple nested sequence properly.';
                  if (B.get ('Data', 'arr2', 1, 0, 'obj') !== 'verynested') return 'B.set didn\'t create multiple nested sequence properly.';
                  if (B.set (['Data', 'arr2'], null) !== true) return 'B.set didn\'t return true.';
                  if (B.get ('Data', 'arr2') !== null) return 'B.set didn\'t overwrite array.';

                  if (B.set (['Data', 'null'], null) !== true) return 'B.set didn\'t return true.';
                  if (Data.null !== null) return 'B.set didn\'t set null value.';
                  if (B.set (['Data', 'null', 'a'], 'b') !== false) return 'B.set didn\'t return false when overwriting parent.';
                  if (B.get ('Data', 'null', 'a') === 'b') return 'B.set overwrote non-complex path.';
                  if (B.set (['Data', 'null', 'a'], 'b', true) !== true) return 'B.set didn\'t return true when overwriting parent with flag.';
                  if (Data.null.a !== 'b') return 'B.set didn\'t overwrite non-complex path when flag was passed.';

                  if (B.rem (['No item'], 0)  !== false) return 'B.rem didn\'t reject target that is simple.';
                  if (B.rem (['Data', 'arr2'], 0)  !== false) return 'B.rem didn\'t reject target that is simple.';
                  if (B.rem (['Data', 'arr', 0], 0)  !== false) return 'B.rem didn\'t reject target that is simple.';
                  if (B.rem ([], []) !== true) return 'B.rem didn\'t return true when removing no keys.';
                  if (B.rem ([]) !== true) return 'B.rem didn\'t return true when removing no keys.';
                  if (B.rem ([], 'Other') !== true) return 'B.rem didn\'t return true.';
                  if (B.get ('Other') !== undefined) return 'B.rem didn\'t remove toplevel property.';
                  if (B.rem (['Data', 'items'], 0, 2) !== true) return 'B.rem didn\'t return true.';
                  if (Data.items.length !== 4) return 'B.rem didn\'t remove array items properly.';
                  if (type (Data.items [0]) !== 'array') return 'B.rem didn\'t remove array items properly.';
                  if (Data.items [1] !== 'four') return 'B.rem didn\'t remove array items properly.';
                  if (B.rem (['Data', 'items'], 0) !== true) return 'B.rem didn\'t return true.';
                  if (Data.items [0] !== 'four') return 'B.rem didn\'t remove array item properly.';
                  if (B.rem (['Data', 'items'], 4, 'nonexistent') !== false) return 'B.rem accepted string element in keys when target was array.';
                  if (B.rem (['Data', 'items'], 'nonexistent') !== false) return 'B.rem accepted string element in keys when target was array.';
                  if (Data.items.length !== 3) return 'B.rem modified array when receiving noninteger index.';
                  if (Data.items [0] !== 'four') return 'B.rem modified array when receiving noninteger index.';
                  if (B.rem (['Data', 'items'], 9) !== true) return 'B.rem didn\'t return true.';
                  if (Data.items.length !== 3) return 'B.rem modified array when receiving out of range index.';
                  if (Data.items [0] !== 'four') return 'B.rem modified array when receiving out of range index.';
                  if (B.rem (['Data', 'items'], 1, 9) !== true) return 'B.rem didn\'t return true.';
                  if (Data.items.length !== 2) return 'B.rem didn\'t modify array when receiving out of range index.';
                  if (Data.items [0] !== 'four') return 'B.rem didn\'t modify array when receiving out of range index.';
                  if (Data.items [1] !== 'seven') return 'B.rem didn\'t modify array when receiving out of range index.';

                  if (B.rem (['Data', 'obj'], 'last') !== true) return 'B.rem didn\'t return true.';
                  if (dale.keys (Data.obj).length !== 0) return 'B.rem didn\'t remove keys from object.';
                  if (B.rem ('Data', 'obj') !== true) return 'B.rem didn\'t return true.';
                  if (Data.obj !== undefined) return 'B.rem didn\'t remove object from array.';
                  if (B.rem ('Data', dale.keys (Data)) !== true) return 'B.rem didn\'t return true.';
                  if (dale.keys (Data).length !== 0) return 'B.rem didn\'t remove multiple objects from array.';

               });

               Test ('args circuit with events', function () {

                  Data.items = [];

                  if (B.get ('Data')            !== Data)       return 'B.get single path comparison #1 didn\'t work.';
                  if (B.get (['Data'])          !== Data)       return 'B.get single path comparison #2 didn\'t work.';
                  if (B.get (['Data', 'items']) !== Data.items) return 'B.get double path comparison #1 didn\'t work.';
                  if (B.get ('Data', 'items')   !== Data.items) return 'B.get double path comparison #2 didn\'t work.';

                  if (B.do ('add', ['Data', 'items'], 'one') !== true) return 'B.add didn\'t return true.';
                  if (B.get ('Data', 'items', 0) !== 'one') return 'B.add didn\'t add element.';
                  if (B.do ('add', ['Data', 'items'], ['two', 'three']) !== true) return 'B.add didn\'t return true.';
                  if (Data.items.length !== 2) return 'B.add didn\'t add array properly.';
                  if (B.get ('Data', 'items', 1, 0) !== 'two') return 'B.add didn\'t add array properly.';
                  if (B.get ('Data', 'items', 1, 1) !== 'three') return 'B.add didn\'t add array properly.';
                  if (B.do ('add', ['Data', 'items'], undefined, 'four', {five: 5}) !== true) return 'B.add didn\'t return true.';
                  if (Data.items.length !== 5) return 'B.add didn\'t add multiple arguments properly.';
                  if (B.get ('Data', 'items', 2) !== undefined) return 'B.add didn\'t add undefined properly.';
                  if (B.get ('Data', 'items', 3) !== 'four') return 'B.add didn\'t add multiple arguments properly.';
                  if (B.get ('Data', 'items', 4, 'five') !== 5) return 'B.add didn\'t add multiple arguments properly.';
                  var backup = teishi.s (B.get ('Data', 'items', 4));
                  B.do ('add', ['Data', 'items', 4], 'six')
                  if (teishi.s (B.get ('Data', 'items', 4)) !== backup) return 'B.add added element to object.';

                  if (B.do ('set', ['Data', 'items', 4, 'six'], 6) !== true) return 'B.set didn\'t return true.';
                  if (B.get ('Data', 'items', 4, 'six') !== 6) return 'B.set didn\'t set object property in existing object.';
                  if (B.do ('set', ['Data', 'items', 5], 'seven') !== true) return 'B.set didn\'t return true.';
                  if (B.get ('Data', 'items', 5) !== 'seven') return 'B.set didn\'t set array element in existing array.';

                  if (B.do ('set', 'Other', true) !== true) return 'B.set didn\'t return true.';
                  if (B.get ('Other') !== true) return 'B.set didn\'t set toplevel property.';

                  if (B.do ('set', ['Data', 'arr', 0], true) !== true) return 'B.set didn\'t return true.';
                  if (type (Data.arr) !== 'array') return 'B.set didn\'t create nested structures (array).';
                  if (B.get ('Data', 'arr', 0) !== true) return 'B.set didn\'t create nested structures (array).';
                  if (B.do ('set', ['Data', 'obj', 'last'], 'playboy') !== true) return 'B.set didn\'t return true.';
                  if (type (Data.obj) !== 'object') return 'B.set didn\'t create nested structures (object).';
                  if (B.get ('Data', 'obj', 'last') !== 'playboy') return 'B.set didn\'t create nested structures (object).';
                  backup = teishi.s (Data);
                  B.do ('set', ['Data', 2], 'two');
                  if (backup !== teishi.s (Data)) return 'B.set overwrite parent.';

                  if (type (Data) !== 'object') return 'B.set overwrote target on type coercion.';
                  if (B.get ('Data', 2) !== undefined) return 'B.set didn\'t write key when target required type coercion.';
                  if (B.do ('set', ['Data', 'arr2', 1, 0, 'obj'], 'verynested') !== true) return 'B.set didn\'t return true.';
                  if (type (B.get ('Data', 'arr2')) !== 'array') return 'B.set didn\'t create multiple nested sequence properly.';
                  if (type (B.get ('Data', 'arr2', 1)) !== 'array') return 'B.set didn\'t create multiple nested sequence properly.';
                  if (type (B.get ('Data', 'arr2', 1, 0)) !== 'object') return 'B.set didn\'t create multiple nested sequence properly.';
                  if (B.get ('Data', 'arr2', 1, 0, 'obj') !== 'verynested') return 'B.set didn\'t create multiple nested sequence properly.';
                  if (B.do ('set', ['Data', 'arr2'], null) !== true) return 'B.set didn\'t return true.';
                  if (B.get ('Data', 'arr2') !== null) return 'B.set didn\'t overwrite array.';

                  if (B.do ('set', ['Data', 'null'], null) !== true) return 'B.set didn\'t return true.';
                  if (Data.null !== null) return 'B.set didn\'t set null value.';
                  backup = teishi.s (Data);
                  B.do ('set', ['Data', 'null', 'a'], 'b');
                  if (backup !== teishi.s (Data)) return 'B.set overwrote parent.';
                  B.do ('set', ['Data', 'null', 'a'], 'b', true);
                  if (Data.null.a !== 'b') return 'B.set didn\'t overwrite non-complex path when flag was passed.';

                  if (B.do ('rem', [], 'Other') !== true) return 'B.rem didn\'t return true.';
                  if (B.do ('rem', [], []) !== true) return 'B.rem didn\'t return true when removing no keys.';
                  if (B.do ('rem', []) !== true) return 'B.rem didn\'t return true when removing no keys.';
                  if (B.get ('Other') !== undefined) return 'B.rem didn\'t remove toplevel property.';
                  if (B.do ('rem', ['Data', 'items'], 0, 2) !== true) return 'B.rem didn\'t return true.';
                  if (Data.items.length !== 4) return 'B.rem didn\'t remove array items properly.';
                  if (type (Data.items [0]) !== 'array') return 'B.rem didn\'t remove array items properly.';
                  if (Data.items [1] !== 'four') return 'B.rem didn\'t remove array items properly.';
                  if (B.do ('rem', ['Data', 'items'], 0) !== true) return 'B.rem didn\'t return true.';
                  if (Data.items [0] !== 'four') return 'B.rem didn\'t remove array item properly.';
                  if (B.do ('rem', ['Data', 'items'], 4, 'nonexistent') !== true) return 'B.rem didn\'t return true.';
                  if (B.do ('rem', ['Data', 'items'], 'nonexistent') !== true) return 'B.rem didn\'t return true.';
                  if (Data.items.length !== 3) return 'B.rem modified array when receiving noninteger index.';
                  if (Data.items [0] !== 'four') return 'B.rem modified array when receiving noninteger index.';
                  if (B.do ('rem', ['Data', 'items'], 9) !== true) return 'B.rem didn\'t return true.';
                  if (Data.items.length !== 3) return 'B.rem modified array when receiving out of range index.';
                  if (Data.items [0] !== 'four') return 'B.rem modified array when receiving out of range index.';
                  if (B.do ('rem', ['Data', 'items'], 1, 9) !== true) return 'B.rem didn\'t return true.';
                  if (Data.items.length !== 2) return 'B.rem didn\'t modify array when receiving out of range index.';
                  if (Data.items [0] !== 'four') return 'B.rem didn\'t modify array when receiving out of range index.';
                  if (Data.items [1] !== 'seven') return 'B.rem didn\'t modify array when receiving out of range index.';

                  if (B.do ('rem', ['Data', 'obj'], 'last') !== true) return 'B.rem didn\'t return true.';
                  if (dale.keys (Data.obj).length !== 0) return 'B.rem didn\'t remove keys from object.';
                  if (B.do ('rem', 'Data', 'obj') !== true) return 'B.rem didn\'t return true.';
                  if (Data.obj !== undefined) return 'B.rem didn\'t remove object from array.';
                  if (B.do ('rem', 'Data', dale.keys (Data)) !== true) return 'B.rem didn\'t return true.';
                  if (dale.keys (Data).length !== 0) return 'B.rem didn\'t remove multiple objects from array.';
               });

               Test ('B.eq', function () {
                  if (! B.eq (Data, {})) return 'B.eq didn\'t compare an object properly.';
                  if (B.eq (Data, [])) return 'B.eq didn\'t compare an object with an array properly.';
                  if (B.eq ({}, [])) return 'B.eq didn\'t compare an object with an array properly.';
                  if (B.eq ([], {})) return 'B.eq didn\'t compare an object with an array properly.';
                  if (! B.eq (['a', 2], ['a', 2])) return 'B.eq didn\'t compare two arrays properly.';
                  if (B.eq (['a', 2], ['a', 3])) return 'B.eq didn\'t compare two arrays properly.';
               });

               B.do ('test', 'B.ev');

            });

            B.listen ('test', 'B.ev', {burn: true}, function () {

               Test ('B.ev validation', function () {
                  if (B.ev () !== false) return 'B.ev accepted no arguments.';
                  if (B.ev (/booyah/) !== false) return 'B.ev accepted invalid attrs.';
                  if (B.ev ({}) !== false) return 'B.ev accepted no evs.';
                  if (B.ev ({}, '') !== false) return 'B.ev accepted invalid evs.';
                  if (B.ev ({}, [['boo', 'a', 'b'], 'a']) !== false) return 'B.ev accepted invalid evs.';
                  if (B.ev ({}, ['boo', 'a', 'b', {foo: 'bar'}]) !== false) return 'B.ev accepted invalid options.';
                  if (B.ev ({}, ['a', 'b']) !== false) return 'B.ev accepted ev with no path.';
                  if (B.ev ({}, ['a', /notaverb/, []]) !== false) return 'B.ev accepted ev with invalid verb.';
                  if (B.ev ({}, ['a', 'b', /notapath/]) !== false) return 'B.ev accepted ev with invalid path.';
                  if (B.ev ({}, [[['a', 'b', 'c']]]) !== false) return 'B.ev accepted ev with invalid path.';
               });

               Test ('B.str', function () {
                  if (B.str ([undefined, null, function () {return true}, false, /a/, 'a', 3, {a: '\'b', c: ['d"', NaN, Infinity], 'e-f': null}]) !== '[undefined, null, function () {return true}, false, /a/, "a", 3, {"a": "\'b", "c": ["d\\"", NaN, Infinity], "e-f": null}]') return 'boom';
                  var test = eval (B.str ([undefined, null, function () {return true}, false, /a/, 'a', 3, {a: '\'b', c: ['d"', NaN, Infinity], 'e-f': null}]));

                  if (test [0] !== undefined) return 'B.str didn\'t set undefined.';
                  if (test [1] !== null) return 'B.str didn\'t set null.';
                  if (test [2] () !== true) return 'B.str didn\'t set function.';
                  if (test [3] !== false) return 'B.str didn\'t set function.';
                  if (type (test [4]) !== 'regex') return 'B.str didn\'t set regex.';
                  if (test [5] !== 'a') return 'B.str didn\'t set string.';
                  if (test [6] !== 3) return 'B.str didn\'t set number.';
                  if (! test [7] || test [7].a !== "'b" || test [7].c [0] !== 'd"' || type (test [7].c [1]) !== 'nan' || test [7].c [2] !== Infinity) return 'B.str didn\'t set object properly.';
               });

               Test ('B.ev valid input', function () {

                  var r = B.ev ({}, ['on', 'a', 'b', {args: null}]);
                  if (! r || r.on !== 'B.do ("a", "b", null);') return 'B.ev didn\'t accept valid input #1.';
                  r = B.ev ({}, ['on', 'a', 'b', {args: [null]}]);
                  if (! r || r.on !== 'B.do ("a", "b", null);') return 'B.ev didn\'t accept valid input #2.';
                  r = B.ev ({}, ['on', 'a', 'b', {args: undefined}]);
                  if (! r || r.on !== 'B.do ("a", "b", undefined);') return 'B.ev didn\'t accept valid input #3.';
                  r = B.ev ({}, ['on', 'a', 'b', {args: [undefined]}]);
                  if (! r || r.on !== 'B.do ("a", "b", undefined);') return 'B.ev didn\'t accept valid input #4.';
                  r = B.ev ({}, ['on', 'a', 'b', {args: /a/}]);
                  if (! r || r.on !== 'B.do ("a", "b", /a/);') return 'B.ev didn\'t accept valid input #5.';
                  r = B.ev ({}, ['on', 'a', 'b', {args: ['c', /a/, undefined, null, Infinity, NaN]}]);
                  if (! r || r.on !== 'B.do ("a", "b", "c", /a/, undefined, null, Infinity, NaN);') return 'B.ev didn\'t accept valid input #6.';
                  r = B.ev ({}, ['on', 'a', 'b', {args: []}]);
                  if (! r || r.on !== 'B.do ("a", "b");') return 'B.ev didn\'t accept valid input #7.';
                  r = B.ev ({}, ['on', 'a', 'b', {args: [['c', /a/, undefined, null, Infinity, NaN]]}]);
                  if (! r || r.on !== 'B.do ("a", "b", ["c", /a/, undefined, null, Infinity, NaN]);') return 'B.ev didn\'t accept valid input #8.';
                  r = B.ev ({}, ['on', 'a', 'b', {args: true}]);
                  if (! r || r.on !== 'B.do ("a", "b", true);') return 'B.ev didn\'t accept valid input #9.';

                  r = B.ev ({}, ['on', 'a', 'b']);
                  if (! r || r.on !== 'B.do ("a", "b", this.value);') return 'B.ev didn\'t accept valid input #10.';

                  r = B.ev ({}, ['on', 'a', 'b', {rawArgs: ['event', 'this']}]);
                  if (! r || r.on !== 'B.do ("a", "b", event, this);') return 'B.ev didn\'t accept valid input #11.';

                  r = B.ev ({}, ['on', 'a', 'b', {args: [[1], '"two'], rawArgs: ['event', 'this']}]);
                  if (! r || r.on !== 'B.do ("a", "b", [1], "\\"two", event, this);') return 'B.ev didn\'t accept valid input #11.';

                  r = B.ev ({}, ['on, off', 'a', 'b']);
                  if (! r || r.on !== 'B.do ("a", "b", this.value);' || r.off !== r.on || dale.keys (r).length !== 2) return 'B.ev didn\'t create comma-separated events #1.';

                  r = B.ev ({}, ['on, off', 'a', 'b', {args: true}]);
                  if (! r || r.on !== 'B.do ("a", "b", true);' || r.off !== r.on || dale.keys (r).length !== 2) return 'B.ev didn\'t create comma-separated events #1.';

                  r = B.ev ({}, ['on', 'a', 'b', {args: 2, rawArgs: 'event'}]);
                  if (! r || r.on !== 'B.do ("a", "b", 2, event);') return 'B.ev didn\'t accept valid input #12';

                  r = B.ev ({}, [['on', 'a', 'b', {args: 2, rawArgs: 'event'}], ['off', 'a', 'b', {args: 2, rawArgs: 'event'}]]);
                  if (! r || r.on !== 'B.do ("a", "b", 2, event);' || r.off !== 'B.do ("a", "b", 2, event);') return 'B.ev didn\'t accept valid input #13';

               });

               B.do ('test', 'B.view');

            });

            var e = function () {};
            var f = function () {};
            var getid = function () {return B.B + (B.count - 1)}

            B.listen ('test', 'B.view', {burn: true}, function () {

               var initialLength = dale.keys (B.routes).length;

               Test ('B.view validation', function () {
                  var routes = dale.keys (B.routes);

                  if (B.view (/notapath/, e) !== false) return 'B.view accepted invalid path.';
                  if (B.view (['path'], {attrs: {id: 'myid'}}, e) !== false) return 'B.view accepted id.';

                  if (B.view ([], /notafun/) !== false) return 'B.view accepted invalid rfun.';

                  if (B.view ([], {tag: 'paprika'}, e) !== false) return 'B.view accepted invalid tag.';
                  if (B.view ([], {tag: /p/}, e) !== false) return 'B.view accepted invalid tag.';

                  if (B.view ([], {attrs: /paprika/}, e) !== false) return 'B.view accepted invalid attrs.';

                  if (B.view ([], {ondraw: /notafun/}, e) !== false) return 'B.view accepted invalid ondraw.';
                  if (B.view ([], {onforget: /notafun/}, e) !== false) return 'B.view accepted invalid onforget.';

                  if (B.view ('verb', 'path', e) !== false) return 'B.view accepted verb + path.';

                  if (B.view ('path', {listen: {verb: 'a', path: 'b', rfun: e}}, e) !== false) return 'B.view accepted listen that is object.';

                  if (B.view ('path', {listen: [{verb: 'a', path: 'b'}]}, e) !== false) return 'B.view accepted listen with invalid args.';

                  if (B.view ('path', {listen: [/notverb/, 'path', e]}, e) !== false) return 'B.view accepted invalid verb in listen.';

                  if (B.view ('path', {listen: [[/notverb/, 'path', e]]}, e) !== false) return 'B.view accepted invalid verb in listen.';

                  if (B.view ('path', {listen: ['verb', /notpath/, e]}, e) !== false) return 'B.view accepted invalid path in listen.';

                  if (B.view ('path', {listen: [['verb', /notpath/, e]]}, e) !== false) return 'B.view accepted invalid path in listen.';

                  if (B.view ('path', {listen: [['verb', 'path', e], ['verb', /path/, e]]}, e) !== false) return 'B.view accepted invalid second listen.';

                  if (B.view ('path', {listen: [['verb', 'path', e], ['verb', /path/, e]]}, e) !== false) return 'B.view accepted invalid second listen.';

                  if (B.view ('path', {listen: ['a', 'b', {id: 'anything'}, e]}) !== false) return 'B.view accepted listener with id.';

                  if (B.view ('path', {listen: [['verb', 'path', e], ['a', 'b', {id: 'anything'}, e]]}) !== false) return 'B.view accepted second listener with id.';

                  if (B.view ('path', {listen: [[['verb', 'path', e]]]}, e) !== false) return 'B.view accepted invalid listen that is too nested.';

                  var invalidView = B.view (['a', 'path'], {ondraw: e, onforget: f}, function () {
                     return /notaview/;
                  });

                  if (type (invalidView) !== 'array') return 'B.view didn\'t return lith when rfun returned invalid lith.';
                  if (lith.g (invalidView) !== '<div id="в' + (B.count - 1) + '" path-в="a:path"><pre>Invalid lith: /notaview/</pre></div>') return 'B.view didn\'t return informative <pre> when rfun returned invalid lith';

                  var id = B.B + (B.count - 1);

                  if (B.routes [id].ondraw !== e) return 'B.view didn\'t correctly place ondraw in the route.';
                  if (B.routes [id].onforget !== f) return 'B.view didn\'t correctly place onforget in the route.';
                  if (type (B.routes [id].view) !== 'array') return 'B.view didn\t correctly place view in the route.';
                  if (B.routes [id].view [0] !== 'pre') return 'B.view didn\t correctly place view in the route.';

                  B.forget (id);

                  if (dale.keys (B.routes).length !== routes.length) return 'B.view generated invalid routes.';
               });

               Test ('B.view valid input', function () {

                  var initial = B.count;

                  var view = B.view ([2, 3], e);

                  if (type (view) !== 'array' || view [0] !== 'div' || type (view [1]) !== 'object' || view [1].id !== getid () || view [1] ['path-' + B.B] !== [2, 3].join (':')) return 'B.view didn\'t initialize view attributes properly with rfun returning undefined.';

                  if (! B.routes [getid ()] || B.routes [getid ()].view !== undefined) return 'B.view didn\'t generate properly route with rfun returning undefined.';

                  view = B.view ('a', function () {return 2});

                  if (type (view) !== 'array' || view [0] !== 'div' || type (view [1]) !== 'object' || view [1].id !== getid () || view [1] ['path-' + B.B] !== 'a') return 'B.view didn\'t initialize view attributes properly #1.';

                  if (! B.routes [getid ()] || B.routes [getid ()].view !== 2) return 'B.view didn\'t properly generate route #1.';

                  view = B.view (['State', 'view'], {tag: 'p', attrs: {}, ondraw: e, onforget: f}, function () {return ['a', 1]});

                  if (type (view) !== 'array' || view [0] !== 'p' || type (view [1]) !== 'object' || view [1].id !== getid () || view [1] ['path-' + B.B] !== 'State:view') return 'B.view didn\'t initialize view attributes properly #2.';

                  if (! B.routes [getid ()] || B.routes [getid ()].verb !== 'change' || B.routes [getid ()].priority !== -1 || ! B.eq (B.routes [getid ()].view, ['a', 1]) || B.routes [getid ()].ondraw !== e || B.routes [getid ()].onforget !== f) return 'B.view didn\'t properly generate route #2.';

                  view = B.view (['State', 'items', 0], {tag: 'input', attrs: {class: 'blue', type: 'text'}}, function () {});

                  if (type (view) !== 'array' || view [0] !== 'input' || type (view [1]) !== 'object' || ! B.eq ({id: getid (), 'path-в': 'State:items:0', class: 'blue', type: 'text'}, view [1])) return 'B.view didn\'t initialize view attributes properly #3.';

                  if (! B.routes [getid ()] || B.routes [getid ()].verb !== 'change' || B.routes [getid ()].priority !== -1 || ! B.eq (B.routes [getid ()].view, undefined)) return 'B.view didn\'t properly generate route #3.';

                  view = B.view ('c', {listen: ['a', 'b', e]}, function () {});

                  if (type (view) !== 'array') return 'B.view didn\'t properly generate route with listener #1.';

                  var listeners = dale.fil (B.routes, undefined, function (route) {
                     if (route.parent === getid ()) return route;
                  });

                  if (listeners.length !== 1 || ! B.eq (listeners [0], {verb: 'a', path: ['b'], id: listeners [0].id, rfun: e, parent: getid ()})) return 'B.view didn\'t register listeners properly #1.';

                  view = B.view ('c', {listen: [['a', 'b', e]]}, function () {});

                  if (type (view) !== 'array' || B.routes [getid ()].verb !== 'change' || B.routes [getid ()].priority !== -1) return 'B.view didn\'t properly generate route with listener #2.';

                  listeners = dale.fil (B.routes, undefined, function (route) {
                     if (route.parent === getid ()) return route;
                  });

                  if (listeners.length !== 1 || ! B.eq (listeners [0], {verb: 'a', path: ['b'], id: listeners [0].id, rfun: e, parent: getid ()})) return 'B.view didn\'t register listeners properly #2.';

                  view = B.view ('c', {listen: [[{verb: 'a', path: 'b'}, e]]}, function () {});

                  if (type (view) !== 'array' || B.routes [getid ()].verb !== 'change' || B.routes [getid ()].priority !== -1) return 'B.view didn\'t properly generate route with listener #3.';

                  listeners = dale.fil (B.routes, undefined, function (route) {
                     if (route.parent === getid ()) return route;
                  });

                  if (listeners.length !== 1 || ! B.eq (listeners [0], {verb: 'a', path: ['b'], id: listeners [0].id, rfun: e, parent: getid ()})) return 'B.view didn\'t register listeners properly #3.';

                  view = B.view ('c', {listen: [['a', 'b', {parent: 'add', priority: 2, burn: true}, e]]}, function () {});

                  if (type (view) !== 'array' || B.routes [getid ()].verb !== 'change' || B.routes [getid ()].priority !== -1) return 'B.view didn\'t properly generate route with listener #4.';

                  var getListener = function () {
                     return dale.stopNot (B.routes, undefined, function (route) {
                        if (route.parent === 'add') return route;
                     });
                  }

                  if (! B.eq (getListener (), {id: getListener ().id, verb: 'a', path: ['b'], parent: 'add', priority: 2, burn: true, rfun: e})) return 'B.view didn\'t register listeners properly #4.';

                  B.forget (getListener ().id);

                  view = B.view ('c', {listen: ['a', 'b', {parent: 'add', priority: 2, burn: true}, e]}, function () {});

                  if (type (view) !== 'array' || B.routes [getid ()].verb !== 'change' || B.routes [getid ()].priority !== -1) return 'B.view didn\'t properly generate route with listener #5.';

                  if (! B.eq (getListener (), {id: getListener ().id, verb: 'a', path: ['b'], parent: 'add', priority: 2, burn: true, rfun: e})) return 'B.view didn\'t register listeners properly #5.';

                  B.forget (getListener ().id);

                  view = B.view ('c', {listen: [['a', 'b', {parent: 'add', priority: 2, burn: true}, e], ['c', 'd', f]]}, function () {});

                  if (type (view) !== 'array' || B.routes [getid ()].verb !== 'change' || B.routes [getid ()].priority !== -1) return 'B.view didn\'t properly generate route with listener #6.';

                  if (! B.eq (getListener (), {id: getListener ().id, verb: 'a', path: ['b'], parent: 'add', priority: 2, burn: true, rfun: e})) return 'B.view didn\'t register listeners properly #6.';

                  B.forget (getListener ().id);

                  listeners = dale.fil (B.routes, undefined, function (route) {
                     if (route.parent === getid ()) return route;
                  });

                  if (listeners.length !== 1 || ! B.eq (listeners [0], {verb: 'c', path: ['d'], id: listeners [0].id, rfun: f, parent: getid ()})) return 'B.view didn\'t register listeners properly #6.';

                  view = B.view ('c', {listen: []}, e);

                  if (! B.eq (view, ['div', {id: 'в20', 'path-в': 'c'}, ['LITERAL', '']])) return 'B.view didn\'t create view with empty listener.';

                  dale.do (dale.times (B.count - initial, initial), function (id) {
                     id = B.B + id;
                     B.forget (id);
                  });

                  if (dale.keys (B.routes).length !== initialLength) return 'Cleanup failed #1.';
               });

               Test ('B.mount & B.unmount invalid input', function () {
                  if (B.mount ('p') !== false) return 'B.mount accepted invalid target #1.';
                  if (B.mount ('#a p') !== false) return 'B.mount accepted invalid target #2.';
                  if (B.mount (22) !== false) return 'B.mount accepted invalid target #3.';
                  if (B.mount ({}) !== false) return 'B.mount accepted invalid target #4.';
                  if (B.mount ('body', /a/) !== false) return 'B.mount accepted invalid view #1.';
                  if (B.mount ('body', {}) !== false) return 'B.mount accepted invalid view #2.';
                  if (B.mount ('body', null) !== false) return 'B.mount accepted invalid view #3.';
                  if (B.mount ('#nosuch', []) !== false) return 'B.mount accepted empty target.';

                  if (B.unmount ('p') !== false) return 'B.unmount accepted invalid target #1.';
                  if (B.unmount ('#a p') !== false) return 'B.unmount accepted invalid target #2.';
                  if (B.unmount (22) !== false) return 'B.unmount accepted invalid target #3.';
                  if (B.unmount ({}) !== false) return 'B.unmount accepted invalid target #4.';
                  if (B.unmount ('#nosuch', []) !== false) return 'B.unmount accepted empty target.';
               });


               Test ('B.mount & B.unmount valid', function () {

                  var original = c ('body *');

                  B.mount ('body', B.view ([], function () {return 1}));

                  var view = c ('#' + getid ());

                  if (! view) return 'B.mount didn\'t place view #1.';
                  if (view.innerHTML !== '1') return 'B.mount didn\'t place contents of view correctly #1.';
                  if (c ('body *') [0] !== view) return 'B.mount didn\'t place view in the right place #1.';

                  B.unmount ('body');

                  if (dale.stop (c ('body *'), true, function (el, k) {
                     return el !== original [k];
                  })) return 'B.mount & B.unmount didn\'t leave everything unchanged.';

                  B.mount ('body', B.view ([], function () {
                     return B.view ([], function () {
                        return {a: 'b'};
                     });
                  }));

                  view = c ('#' + getid ());

                  log (view.innerHTML);

                  if (! view) return 'B.mount didn\'t place view #2.';
                  if (view.innerHTML !== '<pre>Invalid lith: {\n   "a": "b"\n}</pre>') return 'B.mount didn\'t place contents of view correctly #2.';
                  if (c ('body * *') [0] !== view) return 'B.mount didn\'t place view in the right place #2.';

                  B.mount ('body', B.view ([], function () {return ['p', 'a']}));

                  view = c ('#' + getid ());

                  if (! view) return 'B.mount didn\'t place view #3.';
                  if (view.innerHTML !== '<p>a</p>') return 'B.mount didn\'t place contents of view correctly #3.';
                  if (c ('body *') [0] !== view) return 'B.mount didn\'t place view in the right place #3.';

                  B.unmount ('body');

                  if (dale.stop (c ('body *'), true, function (el, k) {
                     return el !== original [k];
                  })) return 'B.mount & B.unmount didn\'t leave everything unchanged.';

                  var counter = 0;

                  B.mount ('body', B.view ([], {
                     ondraw: function (id) {
                        if (id !== getid ()) throw new Error ('ondraw received wrong id.');
                        if (counter !== 0)   throw new Error ('ondraw timing error.');
                        if (! c ('#' + id))  throw new Error ('ondrawwas executed before the DOM elements were placed.');
                        counter++;
                     },
                     onforget: function (id) {
                        if (id !== getid ()) throw new Error ('onforget received wrong id.');
                        if (counter !== 1)   throw new Error ('onforget timing error.');
                        if (! c ('#' + id))  throw new Error ('onforget was executed after the DOM elements were removed.');
                        counter++;
                     },
                  }, function () {return ['p', {class: 'vamo'}]}));

                  view = c ('#' + getid ());

                  if (! view) return 'B.mount didn\'t place view #4.';
                  if (view.innerHTML !== '<p class="vamo"></p>') return 'B.mount didn\'t place contents of view correctly #4.';
                  if (c ('body *') [0] !== view) return 'B.mount didn\'t place view in the right place #4.';

                  if (counter !== 1) return 'ondraw was not executed.';

                  B.unmount ('body');

                  if (counter !== 2) return 'onforget was not executed.';

                  if (dale.stop (c ('body *'), true, function (el, k) {
                     return el !== original [k];
                  })) return 'B.mount & B.unmount didn\'t leave everything unchanged.';

               });

               B.do ('test', 'init');
            });

            var Views = {};

            // *** INIT ***

            B.listen ('test', 'init', {burn: true}, function () {

               // *** BASE VIEW ***

               Views.baseCSS = [
                  ['body', {
                     'background-color': '#c9c9c9',
                     'font-family': '"Arial Narrow", Arial, sans-serif'
                  }],
                  ['#canvas', {
                     width: .9,
                     'min-height': 200,
                     'border-top, border-bottom': 'solid 1px gray',
                     'border-left, border-right': 'solid 2px gray',
                     'margin, overflow': 'auto',
                     'background-color': 'white'
                  }],
                  ['a, u', {cursor: 'pointer', 'text-decoration': 'underline', color: 'blue'}]
               ];

               Views.base = ['div', {id: 'canvas'}, [
                  ['style', lith.css.g (Views.baseCSS)],

                  B.view (['State', 'view'], function (x, view) {
                     return B.view ('State', function (x, state) {
                        return Views [view] ? Views [view] () : state.default;
                     });
                  })
               ]];

               B.mount ('body', Views.base);

               B.do ('set', ['State', 'default'], [['To be'], ' determined']);

               Test ('canvas initialization', function () {
                  if (c ('body #canvas').length        !== 1) return 'Canvas not placed.';
                  if (c ('body #canvas style').length  !== 1) return 'Inner style not placed.';
                  if (c ('body #canvas div div').length !== 1) return 'Inner div not placed.';

                  B.do ('set', ['State', 'default'], ['h1', [['To be'], ' determined']]);
                  if (c ('body #canvas div div h1') [0].innerHTML !== 'To be determined') return 'Content of inner div not placed properly.';

                  var evs = B.debug.length;
                  B.do ('set', ['State', 'default'], ['h1', [['To be'], ' determined']]);
                  if (B.debug.length - evs !== 1) return 'B.change didn\'t prevent redrawing on equal set.';
                  if (c ('body #canvas div div h1') [0].innerHTML !== 'To be determined') return 'Content of inner div not placed properly.';

               });

               Test ('viewroutes', function () {
                  var viewRoutes = dale.fil (dale.keys (B.routes), undefined, function (v) {
                     if (v.match ('в')) return v;
                  });
                  if (viewRoutes.length !== 2) return 'Unexpected viewroutes.';
                  var viewRoute = B.routes [viewRoutes [0]];
                  if (viewRoute.verb !== 'change') return 'Invalid viewroute verb #1.';
                  if (! B.eq (viewRoute.path, ['State', 'view'])) return 'Invalid viewroute path #1.';
                  if (type (viewRoute.view) !== 'array') return 'Invalid viewroute view #1.';
                  if (viewRoute.priority !== -1) return 'Invalid viewroute priority #1.';

                  viewRoute = B.routes [viewRoutes [1]];
                  if (viewRoute.verb !== 'change') return 'Invalid viewroute verb #2.';
                  if (! B.eq (viewRoute.path, ['State'])) return 'Invalid viewroute path #2.';
                  if (type (viewRoute.view) !== 'array') return 'Invalid viewroute view #2.';
                  if (viewRoute.priority !== -2) return 'Invalid viewroute priority #2.';
               });

               Test ('dangling', function () {

                  var d1 = B.view ([], function () {});

                  B.do ('set', ['Data', 'test'], 1);

                  var viewRoutes = dale.fil (dale.keys (B.routes), undefined, function (v) {
                     if (v.match ('в')) return v;
                  });

                  if (viewRoutes.length !== 2) return 'Dangling route was not removed.';

                  if (! B.eq (B.debug [0], {verb: 'change', path: ['Data', 'test']})) return 'change event fired with wrong parameters.';

               });

               B.do ('test', 'args');
            });

            // *** ARGS TEST ***

            B.listen ('test', 'args', {burn: true}, function () {

               Views.args = function () {
                  return [
                     B.view (['Data', 'title'], {tag: 'h1', attrs: {class: 'opa'}}, function (x, title) {return title}),
                     ['div', {class: 'nav'}, B.view (['Data', 'items'], function (x, items) {
                        return ['ul', {class: 'items'}, dale.do (items, function (v, k) {
                           return ['li', {class: k}, v];
                        })];
                     })],
                  ];
               }

               B.do ('set', ['State', 'view'], 'args');

               Data.items = [];

               Test ('change view to args', function () {
                  if (State.view !== 'args') return 'Data item not set!';
               });

               Test ('args view placed', function () {
                  if (! c ('#canvas div div.nav')) return 'nav div not placed.';
                  if (c ('#canvas div div.nav div ul.items') [0].innerHTML !== '') return 'ul not placed.';
               });

               B.do ('set', ['Data', 'title'], 'One big title.');

               Test ('view changed after set operation', function () {
                  if (c ('#canvas h1') [0].innerHTML !== Data.title) return 'title not placed correctly.';
               });

               dale.do (['a', 'b', 'c', 'd'], function (v) {
                  B.do ('add', ['Data', 'items'], v);
               });

               Test ('views updated after add operation', function () {
                  if (JSON.stringify (Data.items) !== JSON.stringify (['a', 'b', 'c', 'd'])) return 'add not working properly.';
                  if (c ('ul.items li').length !== 4) return 'ul contents not updated.';
               });

               B.do ('rem', ['Data', 'items'], [0, 2]);

               Test ('views updated after rem operation', function () {
                  if (JSON.stringify (Data.items) !== JSON.stringify (['b', 'd'])) return 'rem not working properly.';
                  if (c ('ul.items li').length !== 2) return 'ul contents not updated.';
                  if (c ('ul.items li') [0].innerHTML !== 'b') return 'rem not working properly.';
               });

               B.do ('set', ['Data', 'items', 1], 'e');

               Test ('views updated after set in array', function () {
                  if (JSON.stringify (Data.items) !== JSON.stringify (['b', 'e'])) return 'rem not working properly.';
                  if (c ('ul.items li').length !== 2) return 'ul contents not updated.';
                  if (c ('ul.items li') [1].innerHTML !== 'e') return 'rem not working properly.';
               });

               B.do ('set', ['Data', 'items'], {a: 'b', c: 'd'});

               Test ('views updated after setting object', function () {
                  if (JSON.stringify (Data.items) !== JSON.stringify ({a: 'b', c: 'd'})) return 'rem not working properly.';
                  if (c ('ul.items li').length !== 2) return 'ul contents not updated.';
                  if (c ('ul.items li.a').length !== 1) return 'ul contents not updated.';
                  if (c ('ul.items li') [1].innerHTML !== 'd') return 'rem not working properly.';
               });

               B.do ('rem', ['Data', 'items'], 'a');

               Test ('views updated after removal', function () {
                  if (JSON.stringify (Data.items) !== JSON.stringify ({c: 'd'})) return 'rem not working properly.';
                  if (c ('ul.items li').length !== 1) return 'ul contents not updated.';
                  if (c ('ul.items li.c').length !== 1) return 'ul contents not updated.';
               });

               B.do ('rem', ['Data', 'items'], dale.keys (Data.items));

               Test ('views updated after complete removal', function () {
                  if (JSON.stringify (Data.items) !== JSON.stringify ({})) return 'rem not working properly.';
                  if (c ('ul.items li').length !== 0) return 'ul contents not updated.';
                  if (c ('ul.items li.c').length !== 0) return 'ul contents not updated.';
               });

               B.do ('test', 'B.view additional');

            });

            // *** B.VIEW ADDITIONAL TESTS ***

            B.listen ('test', 'B.view additional', {burn: true}, function () {

               var counter1 = 0, counter2 = 0;

               Views.escapes = function () {
                  return B.view (['same', 'path'], function () {
                     return [
                        ['table', [
                           ['thead', ['th']],
                           ['tr', ['td', '"I have \'quotes\'!"']]
                        ]],
                        B.view (['same', 'path'], function () {
                           return ['table', ['tbody', ['tr', ['td', '<`Me & you too!`>']]]];
                        }),
                        B.view (['same', 'path'], function () {
                           return ['table', ['tr', ['td', '<eval>hack ()</eval>']]];
                        }),
                        B.view (['same', 'path'], function () {
                           return ['table', [['thead'], [['tr', ['td', '<eval>hack ()</eval>']], ['br']]]];
                        }),
                        B.view (['same', 'path'], function () {
                           return ['table', ['thead']];
                        }),
                        B.view (['same', 'path'], {ondraw: function () {
                           if (B.get ('same', 'path') === undefined) B.do ('set', ['same', 'path'], 1);
                        }}, function () {
                           return ['table', ['br']];
                        })
                     ];
                  });
               }

               B.do ('set', ['State', 'view'], 'escapes');

               Test ('B.view quotes & special characters; and tbodys!', function () {

                  B.do ('change', ['same', 'path']);
                  if (c ('table').length !== 6) return 'tables weren\'t created.';
                  if (c ('tbody').length !== 5) return 'tbodys weren\'t created.';

                  if (c ('table') [0].innerHTML !== '<thead><th></th></thead><tbody><tr><td>"I have \'quotes\'!"</td></tr></tbody>') return 'table #1 was not created properly.';
                  if (c ('table') [1].innerHTML !== '<tbody><tr><td>&lt;`Me &amp; you too!`&gt;</td></tr></tbody>') return 'table #2 was not created properly.';
                  if (c ('table') [2].innerHTML !== '<tbody><tr><td>&lt;eval&gt;hack ()&lt;/eval&gt;</td></tr></tbody>') return 'table #3 was not created properly.';
                  if (c ('table') [3].innerHTML !== '<thead></thead><tbody><tr><td>&lt;eval&gt;hack ()&lt;/eval&gt;</td></tr><br></tbody>') return 'table #4 was not created properly.';

                  if (c ('table') [4].innerHTML !== '<thead></thead>') return 'table #5 was not created properly.';

                  if (c ('table') [5].innerHTML !== '<tbody><br></tbody>') return 'table #6 was not created properly.';

                  B.do ('change', ['same', 'path']);

                  if (c ('table') [0].innerHTML !== '<thead><th></th></thead><tbody><tr><td>"I have \'quotes\'!"</td></tr></tbody>') return 'table #1 was not created properly.';
                  if (c ('table') [1].innerHTML !== '<tbody><tr><td>&lt;`Me &amp; you too!`&gt;</td></tr></tbody>') return 'table #2 was not created properly.';
                  if (c ('table') [2].innerHTML !== '<tbody><tr><td>&lt;eval&gt;hack ()&lt;/eval&gt;</td></tr></tbody>') return 'table #3 was not created properly.';
                  if (c ('table') [3].innerHTML !== '<thead></thead><tbody><tr><td>&lt;eval&gt;hack ()&lt;/eval&gt;</td></tr><br></tbody>') return 'table #4 was not created properly.';

                  if (c ('table') [4].innerHTML !== '<thead></thead>') return 'table #5 was not created properly.';

                  if (c ('table') [5].innerHTML !== '<tbody><br></tbody>') return 'table #6 was not created properly.';
               });

               Views.tablebr = function () {
                  return B.view (['a', 'path'], function () {
                     return ['table', ['br']];
                  });
               }

               B.do ('set', ['State', 'view'], 'tablebr');

               B.do ('set', ['Data', 'viewevent1'], 7);
               B.do ('set', ['Data', 'viewevent2'], 9);

               Views.viewevents = function () {
                  return B.view (['Data', 'viewevent1'], {
                     ondraw:   function (id) {checkid (id); checktd ('ondraw1'); Data.ondraw1++},
                     onforget: function (id) {checkid (id); checktd ('onforget1'); Data.onforget1++},
                     listen: ['a', 'b', function () {}]
                  }, function (x, viewevent1) {
                     return B.view (['Data', 'viewevent2'], {
                        ondraw:   function (id) {checkid (id); checktd ('ondraw2'); Data.ondraw2++},
                        onforget: function (id) {checkid (id); Data.onforget2++},
                        listen: [
                           ['a', 'b', function () {}],
                           ['a', 'b', function () {}],
                        ],
                     }, function (x, viewevent2) {
                        return ['td', {id: 'td'}, viewevent1 + viewevent2];
                     });
                  });
               }

               Data.ondraw1 = 0;
               Data.ondraw2 = 0;
               Data.onforget1 = 0;
               Data.onforget2 = 0;

               var checktd = function (where) {
                  if (parseInt (c ('#td').innerHTML) !== (Data.viewevent1 + Data.viewevent2)) throw new Error ('ondraw/onforget timing error: ' + where);
               }

               var checkid = function (id) {
                  if (type (id) !== 'string' || ! id.match (/^в[0-9a-f]+$/)) throw new Error ('ondraw/onforget didn\'t receive valid id.');
               }

               var compare = function (comparison) {
                  return ('' + Data.ondraw1 + Data.ondraw2 + Data.onforget1 + Data.onforget2) !== comparison;
               }

               B.do ('set', ['State', 'view'], 'viewevents');

               Test ('Testing view events', function () {
                  if (compare ('1100')) return 'ondraw/onforget didn\'t work #1.';
                  B.do ('set', ['Data', 'viewevent2'], 11);
                  if (compare ('1200')) return 'ondraw/onforget didn\'t work #2.';
                  B.do ('set', ['Data', 'viewevent1'], 4);
                  if (compare ('2301')) return 'ondraw/onforget didn\'t work #3.';
                  B.do ('change', ['State'], State);
                  if (compare ('3412')) return 'ondraw/onforget didn\'t work #4.';
                  B.do ('set', ['State', 'view'], 'bla');
                  if (compare ('3423')) return 'ondraw/onforget didn\'t work #5.';
               });

               Views.listen = function () {
                  return B.view (['Data'], function (x, Data) {
                     return [
                        Data.extra ? [
                           ['input', {value: 'throw focus off'}],
                           ['input', {value: 'throw focus off'}],
                           ['input', {value: 'throw focus off'}],
                        ] : [],
                        ['input', B.ev ({id: 'user', value: B.get ('Data', 'user')},                   ['onchange', 'set', ['Data', 'user']])],
                        ['input', B.ev ({id: 'pass', value: B.get ('Data', 'pass'), type: 'password'}, ['onchange', 'set', ['Data', 'pass']])]
                     ];
                  });
               }

               B.do ('set', ['State', 'view'], 'listen');

               c ('#user').focus ();

               B.do ('set', ['Data', 'user'], 'hello!');
               B.do ('set', ['Data', 'pass'], 'secreto');

               B.do ('set', ['Data', 'extra'], true);

               Test ('Focus & value tests', function () {
                  if (document.activeElement !== c ('#user')) return 'focus wasn\'t preserved when it should.';

                  if (c ('#user').value !== 'hello!') return 'value wasn\'t preserved when it should.';
               });

               // *** OPAQUE ***

               Views.opaque = function () {

                  return B.view (['State', 'ltable'], function (x, ltable) {
                     return B.view (['State'], function (x, State) {
                        return ['table', dale.do (dale.times (ltable), function (v) {
                           return ['tr', dale.do (dale.times (ltable), function (v2, k2) {
                              if (k2 === 0) return ['td', {class: 'something ' + State.opaqueclass, opaque: true}, ['input']];
                              else return ['td', k2];
                           })];
                        })];
                     });
                  });
               }

               B.do ('set', ['State', 'ltable'], 2);
               B.do ('set', ['State', 'view'], 'opaque');

               Test ('Testing opaque elements', function () {
                  var opaques = c ('.something');
                  if (opaques.length !== 2) return 'Opaques were not created.';
                  opaques = c ('.something input');
                  if (opaques.length !== 2) return 'Opaque contents were not created.';

                  c.fill ('.something', '<input><input>');
                  B.do ('set', ['State', 'ltable'], 4);
                  opaques = c ('.something');
                  if (opaques.length !== 4) return 'Opaques were not updated 1.';
                  opaques = c ('.something input');
                  if (opaques.length !== 4) return 'Opaque contents were not updated 1.';

                  c.fill ('.something', 'boo');
                  if (c ('.something') [0].innerHTML !== 'boo') return 'Opaque contents were not updated.';

                  B.do ('set', ['State', 'ltable'], 5);
                  opaques = c ('.something');
                  if (opaques.length !== 5) return 'Opaques were not updated 2.';
                  opaques = c ('.something input');
                  if (opaques.length !== 5) return 'Opaque contents were not updated 2.';

                  c.fill ('.something', '<div><input><span></span></div>');

                  B.do ('set', ['State', 'ltable'], 4);
                  B.do ('set', ['State', 'opaqueclass'], 'style');

                  opaques = c ('.style');
                  if (opaques.length !== 4) return 'Opaques were not updated 3.';
                  opaques = c ('.style input');
                  if (opaques.length !== 4) return 'Opaque contents were not updated 3.';
               });

               B.do ('test', 'prediff');

            });

            // *** PREDIFF TEST ***

            B.listen ('test', 'prediff', {burn: true}, function () {

               Views.prediff = function () {return [['just'], 'some', 'strings']}

               B.do ('set', ['State', 'view'], 'prediff');

               Test ('B.prediff', function () {
                  if (c ('div#canvas div div') [0].innerHTML !== 'justsomestrings') return 'prediff test wasn\'t passed.';
               });

               B.do ('test', 'events');
            });

            // *** EVENTS TEST ***

            B.listen ('test', 'events', {burn: true}, function () {

               Views.events = function () {
                  return B.view (['Data'], {listen: [
                     ['upload', 'i2', function (x, arg2, arg3) {
                        Test ('form upload', function () {
                           if (JSON.stringify ({user: 'Talk about', pass: 'thepassion'}) !== JSON.stringify (Data.i2)) return 'form values weren\'t updated.';
                           if (arg2 !== '"a"' || arg3 !== ',"b"') return 'extra args weren\'t passed properly.';
                        });
                     }],
                     ['just', ['another', 'route'], function () {}]
                  ]}, function (x, Data) {
                     return [
                        ['input', B.ev ({id: 'i1', value: B.get ('Data', 'i1')}, ['onchange', 'set', ['Data', 'i1']])],
                        ['form', {id: 'i2'}, [
                           ['input', B.ev ({name: 'user', type: 'text', value: B.get ('Data', 'i2', 'user')}, ['onchange', 'set', ['Data', 'i2', 'user']])],
                           Data.i8 ? [] : ['input'],
                           Data.i7 ? [] : ['input', {id: 'i7'}],
                           ['input', B.ev ({name: 'pass', type: 'password', value: B.get ('Data', 'i2', 'pass')}, ['onchange', 'set', ['Data', 'i2', 'pass']])],
                           ['input', B.ev ({type: 'button', value: 'Submit'}, ['onclick', 'upload', 'i2', {args: ['"a"', ',"b"']}])]
                        ]],
                        ['textarea', B.ev ({id: 'i3'}, ['onchange', 'set', ['Data', 'i3']]), B.get ('Data', 'i3')],
                        ['form', {id: 'i4'}, [
                           ['label', 'Fries'],
                           ['input', B.ev ({
                              type: 'checkbox',
                              checked: B.get ('Data', 'i4', 'fries'),
                           }, ['onchange', 'set', ['Data', 'i4', 'fries'], {args: ! B.get ('Data', 'i4', 'fries')}])],
                        ]],
                        ['form', {id: 'i5'}, dale.do (['red', 'green', 'blue'], function (v) {
                           return [
                              ['label', v],
                              ['input', B.ev ({name: 'colors', type: 'radio', checked: B.get ('Data', 'i5') === v}, ['onchange', 'set', ['Data', 'i5'], {args: v}])]
                           ];
                        })],
                        ['br'],
                        ['select', B.ev ({}, ['onchange', 'set', ['Data', 'i6']]), dale.do (['select one', 'leisure', 'ok computer', 'second coming'], function (v) {
                           return ['option', {selected: B.get ('Data', 'i6') === v ? true : undefined, value: v}, v];
                        })]
                     ];
                  });
               }

               B.do ('set', ['State', 'view'], 'events');

               Test ('events', function () {
                  c.set ('#i1', {value: 'i1'});
                  if (Data.i1 !== 'i1') return 'input onchange didn\'t update properly.';
                  B.do ('set', ['Data', 'i1'], 'i1plus');
                  if (c.get ('#i1', 'value').value !== 'i1plus') return 'input wasn\'t refreshed properly.';

                  c.set ('#i2 [name="user"]', {value: 'Talk about'});
                  c.set ('#i2 [name="pass"]', {value: 'thepassion'});

                  // http://stackoverflow.com/a/20548330
                  try {
                     var ev = new Event ('click');
                     c ('#i2 [type="button"]') [0].dispatchEvent (ev);
                  }
                  catch (error) {
                     c ('#i2 [type="button"]') [0].click ();
                  }

                  B.do ('set', ['Data', 'i3'], 'some text');
                  if (c ('#i3').value !== 'some text') return 'textarea wasn\'t set properly';

                  B.do ('set', ['Data', 'i4', 'fries'], true);
                  if (c ('#i4 input') [0].checked !== true) return 'checkbox wasn\'t checked.';

                  try {
                     c ('#i4 input') [0].dispatchEvent (new Event ('change'));
                  }
                  catch (error) {
                     //http://stackoverflow.com/a/13439901
                     if (document.createEvent) {
                        var ev = document.createEvent ('Event');
                        ev.initEvent ('change', true, true);
                        c ('#i4 input') [0].dispatchEvent (ev);
                     }
                  }

                  if (B.get ('Data', 'i4', 'fries') !== false) return 'checkbox didn\'t change data after being changed.';
                  if (c ('#i4 input') [0].checked !== false) return 'checkbox wasn\'t unchecked.';

                  B.do ('set', ['Data', 'i5'], 'green');
                  if (c ('#i5 input') [1].checked !== true) return 'radio wasn\'t selected.';

                  B.do ('set', ['Data', 'i6'], 'ok computer');

                  if (c ('option') [2].selected !== true)       return 'select wasn\'t updated after data change 1.';
                  if (c ('select') [0].value !== 'ok computer') return 'select wasn\'t updated after data change 2.';

                  c ('#i7').focus ();

                  B.do ('set', ['Data', 'i8'], true);

                  if (document.activeElement !== c ('#i7')) return 'focus wasn\'t preserved when it should.';

                  B.do ('set', ['Data', 'i7'], true);

                  if (document.activeElement !== null && document.activeElement !== c ('body') [0]) {
                     return 'focus was preserved when it shouldn\'t.';
                  }

               });

               Views.selfmodify = function () {
                  return B.view (['State', 'self'], {tag: 'div', attrs: {class: 'self'}, ondraw: function () {
                     if (! B.get ('State', 'self')) B.do ('set', ['State', 'self'], 1);
                  }}, function (x, self) {
                     return dale.do (dale.times (50), function () {
                        return ['td', self];
                     });
                  });
               }

               B.do ('set', ['State', 'view'], 'selfmodify');

               Test ('B.view selfmodify', function () {
                  var targets = c ('div.self td');
                  if (targets.length !== 50) return 'selfmodify didn\'t update tds #1.';
                  if (targets [0].innerHTML !== '1') return 'selfmodify didn\'t update tds #2.';
               });

               Views.simult = function () {
                  return [
                     B.view (['Data', 'self'], {ondraw: function () {
                        if (! B.get ('Data', 'self')) {
                           if (B.resolvequeue.length !== 1) throw new Error ('B.resolvequeue error.');
                           B.do ('set', ['Data', 'self'], 1);
                           if (B.resolvequeue.length !== 3) throw new Error ('B.resolvequeue error.');
                        }
                     }},
                     function (x, self) {
                        return ['td', self];
                     }),
                     B.view (['Data', 'self'], function (x, self) {
                        return ['td', self];
                     })
                  ];
               }

               B.do ('set', ['State', 'view'], 'simult');

               Test ('B.view simult', function () {
                  var targets = c ('td');
                  if (targets.length !== 2) return 'simult didn\'t update tds #1.';
                  if (targets [0].innerHTML !== '1') return 'simult didn\'t update tds #2.';
               });

               B.trample = 2;

               Views.trample = function () {
                  return B.view (['State', 'items'], function (x, items) {
                     return ['table', [
                        ['thead', ['tr', ['td', 'items']]],
                        ['tbody', dale.do (items, function (v) {
                           return ['tr', ['td', v]];
                        })]
                     ]];
                  });
               }

               B.do ('set', ['State', 'view'], 'trample');

               Test ('B.resolve trample', function () {
                  if (c ('table') [0].innerHTML !== '<thead><tr><td>items</td></tr></thead><tbody></tbody>') return 'booyah';
                  B.do ('set', ['State', 'items'], dale.times (1000));
                  var t = Date.now ();
                  B.do ('set', ['State', 'items'], dale.times (1));
                  if (Date.now () - t > 100) return 'B.trample is not working!';
               });

               B.do ('test', 'attrs');

            });

            // *** ATTRS TEST ***

            B.listen ('test', 'attrs', {burn: true}, function () {

               B.do ('set', ['Data', 'items'], [
                  {id: 'widget1', title: 'Widget #1', price: 5,  checked: false},
                  {id: 'widget2', title: 'Widget #2', price: 8,  checked: true},
                  {id: 'widget3', title: 'Widget #3', price: 11, checked: true},
                  {id: 'widget4', title: 'Widget #4', price: 4,  checked: false}
               ]);

               Views.attrs = function () {
                  return B.view (['Data'], function (x, Data) {
                     return ['table', dale.do (Data.items, function (item, k) {
                        if (Data.filter && Data.filter.match (item.title) === null) return;
                        return ['tr', dale.do (['id', 'title', 'price', 'checked'], function (key) {
                           if (key === 'checked') return ['td', [
                              ['input', B.ev ({type: 'checkbox', checked: B.get ('Data', 'items', k, 'checked')}, ['onchange', 'set', ['Data', 'items', k, 'checked'], {args: ! B.get ('Data', 'items', k, 'checked')}])]
                           ]];
                           return ['td', item [key]];
                        })];
                     })];
                  });
               }

               B.do ('set', ['State', 'view'], 'attrs');

               log (c ('input') [0].checked);

               Test ('attrs', function () {
                  if (c ('input') [0].checked !== false) return 'wrong checkbox was checked.';
                  if (c ('input') [1].checked !== true) return 'checkbox wasn\'t checked.';
                  if (c ('input') [2].checked !== true) return 'checkbox wasn\'t checked.';
                  if (c ('input') [3].checked !== false) return 'wrong checkbox was checked.';

                  B.do ('set', ['Data', 'filter'], 'booyah');
                  B.do ('set', ['Data', 'filter'], '');

                  if (c ('input') [0].checked !== false) return 'wrong checkbox was checked.';
                  if (c ('input') [1].checked !== true) return 'checkbox wasn\'t checked.';
                  if (c ('input') [2].checked !== true) return 'checkbox wasn\'t checked.';
                  if (c ('input') [3].checked !== false) return 'wrong checkbox was checked.';

               });

               B.do ('test', 'perf');

            });

            // *** PERFORMANCE ***

            B.listen ('test', 'perf', {burn: true}, function () {

               Views.perf = function () {
                  return B.view (['Data', 'perf'], function (x, perf) {
                     if (! perf) return [];
                     return ['table', {style: 'display: block'}, dale.do (perf.data, function (v, k) {
                        return ['tr', dale.do (v, function (v2) {
                           return ['td', {class: perf.class}, k + '-' + v2];
                        })];
                     })];
                  });
               }

               var data = dale.do (dale.times (40), function (v) {
                  return dale.do (dale.times (5), function (v2) {
                     return v2;
                  });
               });

               Time ['1: beforeperf'] = Date.now () - dale.acc (Time, function (a, b) {return a + b});

               log ('Starting perf');

               B.do ('set', ['State', 'view'], 'perf');

               Time ['2: perfsetview'] = Date.now () - dale.acc (Time, function (a, b) {return a + b});

               log ('Done setting view');

               B.do ('set', ['Data', 'perf'], {});
               B.do ('set', ['Data', 'perf', 'data'], data);
               Time ['3: perfsetdata'] = Date.now () - dale.acc (Time, function (a, b) {return a + b});
               log ('Done updating view with all data');

               B.do ('set', ['Data', 'perf', 'data', 10, 2], 'something');
               Time ['4: perfupdateone'] = Date.now () - dale.acc (Time, function (a, b) {return a + b});
               log ('Done updating one item');

               B.do ('set', ['Data', 'perf', 'class'], 'aclass');
               Time ['5: perfupdateall'] = Date.now () - dale.acc (Time, function (a, b) {return a + b});
               log ('Done updating all items');

               B.do ('rem', ['Data', 'perf', 'data', 10], 2);
               Time ['6: perfrem'] = Date.now () - dale.acc (Time, function (a, b) {return a + b});

               log ('Done removing one item');

               B.do ('add', ['Data', 'perf', 'data', 10], 999);

               Time ['7: perfadd'] = Date.now () - dale.acc (Time, function (a, b) {return a + b});

               Time ['8: total'] = dale.acc (dale.fil (Time, undefined, function (v, k) {
                  if (k !== 'zero') return v;
               }), function (a, b) {return a + b});

               delete Time.zero;

               log ('Done adding one item');

               B.do ('test', 'success');

            });

            Views.done = function () {
               return [
                  ['h1', 'All tests were successful!'],
                  ['pre', JSON.stringify (Time, null, '   ')],
               ];
            }

            B.listen ('test', 'success', {burn: true}, function () {

               Test ('Route cleanup', function () {
                  if (dale.keys (B.routes).length !== 7) return 'Some routes were not cleaned up!';
               });

               B.do ('set', ['State', 'view'], 'done');

               log ('Success', 'All tests were successful!');
            });

         }) ();
      </script>
   </body>
</html>
